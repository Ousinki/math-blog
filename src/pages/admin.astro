---
// Decap CMS Admin é¡µé¢
---
<!DOCTYPE html>
<html lang="zh-CN">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<title>å†…å®¹ç®¡ç† - Admin</title>
	<style>
		body {
			margin: 0;
			padding: 0;
			font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
		}
	</style>
</head>
<body>
	<!-- Explicitly link config.yml -->
	<link href="/admin/config.yml" type="text/yaml" rel="cms-config-url" />
	
	<!-- Force authentication handler -->
	<script is:inline>
		(function() {
			let authToken = null;
			
			// Listen for auth messages
			window.addEventListener("message", (event) => {
				console.log("Admin window received message:", event.data);
				
				// Try to parse the message
				let token = null;
				
				// Format 1: String "authorization:github:success:{json}"
				if (typeof event.data === 'string' && event.data.startsWith('authorization:github:success:')) {
					try {
						const jsonStr = event.data.replace('authorization:github:success:', '');
						const data = JSON.parse(jsonStr);
						token = data.token;
						console.log("Extracted token from string format:", token);
					} catch (e) {
						console.error("Failed to parse auth message:", e);
					}
				}
				
				// Format 2: Object { type: "authorization", ... }
				if (typeof event.data === 'object' && event.data.type === 'authorization') {
					token = event.data.token;
					console.log("Extracted token from object format:", token);
				}
				
				if (token) {
					authToken = token;
					console.log("Auth token received:", token);
					
					// Store in localStorage (multiple formats)
					localStorage.setItem('netlify-cms-user', JSON.stringify({
						token: token,
						backendName: 'github'
					}));
					
					localStorage.setItem('decap-cms-user', JSON.stringify({
						token: token,
						backendName: 'github'
					}));
					
					// Try to trigger CMS reload
					setTimeout(() => {
						console.log("Reloading to apply authentication...");
						window.location.reload();
					}, 500);
				}
			});
			
			console.log("Decap CMS auth handler installed");
		})();
	</script>

	<!-- åŒ…å« Decap CMS -->
	<script src="https://cdn.jsdelivr.net/npm/decap-cms@^3.0.0/dist/decap-cms.js"></script>
	
	<!-- ç­‰å¾…CMSåŠ è½½å®Œæˆåæ³¨å†ŒVideoç»„ä»¶ -->
	<script type="module">
		console.log('ğŸ“ Script loaded, waiting for CMS...');
		
		let attempts = 0;
		const maxAttempts = 50;
		
		function registerVideo() {
			attempts++;
			
			if (!window.CMS) {
				console.log(`â³ Attempt ${attempts}: CMS not ready yet...`);
				if (attempts < maxAttempts) {
					setTimeout(registerVideo, 200);
				} else {
					console.error('âŒ Failed to load CMS after', maxAttempts * 200, 'ms');
				}
				return;
			}
			
			if (!window.CMS.registerEditorComponent) {
				console.log(`â³ Attempt ${attempts}: registerEditorComponent not available yet...`);
				if (attempts < maxAttempts) {
					setTimeout(registerVideo, 200);
				}
				return;
			}
			
			try {
				console.log('ğŸ¬ CMS ready! Registering Video component...');
				
				window.CMS.registerEditorComponent({
					id: "video",
					label: "Video", 
					fields: [{
						name: 'src',
						label: 'Video',
						widget: 'file',
						media_folder: '/public/video',
						allow_multiple: false,
						hint: 'é€‰æ‹©è§†é¢‘æ–‡ä»¶æˆ–è¾“å…¥è§†é¢‘URL'
					}],
				// åŒ¹é…HTML videoæˆ–Videoç»„ä»¶
				pattern: /<video[\s\S]*?<source\s+src="([^"]+)"[\s\S]*?<\/video>|<Video\s+src="([^"]+)"\s*\/>/,
				fromBlock(match) {
					// match[1] æ˜¯ HTML video çš„ src, match[2] æ˜¯ Video ç»„ä»¶çš„ src
					return { src: match[1] || match[2] || '' };
				},
				toBlock(data) {
					const src = data.src || '';
					return `<video controls width="100%" style="border-radius: 8px;">
  <source src="${src}" type="video/mp4" />
  æ‚¨çš„ç€è¦½å™¨ä¸æ”¯æŒè¦–é »æ¨™ç±¤ã€‚
</video>`;
				},
				toPreview(data) {
					const src = data.src || '';
					return `<div style="margin:15px 0;padding:12px;background:#f0f0f0;border-radius:6px;">
						<video controls style="width:100%;max-width:600px;border-radius:4px;">
							<source src="${src}" type="video/mp4" />
						</video>
						<p style="margin:8px 0 0;font-size:11px;color:#666;">è§†é¢‘: ${src}</p>
					</div>`;
				}
				});
				
				console.log('âœ… Video component registered successfully!');
				console.log('ğŸ’¡ Now click the + button in Body editor');
				console.log('ğŸ“Œ You should see: Choose a video / Insert from URL');
				
			} catch (error) {
				console.error('âŒ Error registering Video component:', error);
				console.error('Error details:', error.message, error.stack);
			}
		}
		
		// å¼€å§‹æ³¨å†Œ
		registerVideo();
	</script>
</body>
</html>
